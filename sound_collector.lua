check_list_data = {
   MegaMan1={
      initial={
         "0_",
      },
      choose_screen={
         "0_213_269_359_269_213_269_359_",
         "213_269_359_269_213_269_359_0_213_0_359_",
         "0_213_269_359_269_213_269_359_0_",
         "213_269_359_0_213_0_359_0_240_269_359_",
      },
      choose_robotmaster={
         "25_285_53_23_285_53_21_285_53_285_30_285_26_",
         "23_285_53_21_285_53_285_30_285_26_28_285_26_",
         "21_285_53_285_30_285_26_28_285_26_26_285_26_",
      },
      cutman={
         "5_169_682_269_5_169_685_269_5_169_682_269_5_169_679_269_5_169_676_269_",
         "0_5_169_682_269_5_169_685_269_5_169_682_269_5_169_679_269_",
         "379_252_0_5_169_682_269_5_169_685_269_5_169_682_269_",
         "5_505_285_5_508_285_5_511_285_5_514_285_5_511_285_",
         "5_508_285_5_511_285_5_514_285_5_511_285_0_",
      },
      gutsman={
         "6_381_381_427_381_381_381_427_0_6_302_381_381_",
         "381_381_427_0_6_302_381_381_381_381_381_427_",
         "5_381_427_0_6_302_381_381_",
         "238_571_287_240_0_285_6_242_285_283_6_240_285_285_6_238_285_287_",
         "6_242_571_283_6_240_571_285_6_238_571_287_238_0_287_6_242_0_287_",
         "6_192_285_242_6_190_285_240_6_188_285_238_6_190_285_240_6_192_285_242_"
      },
      elecman={
         "456_503_550_597_644_",
         "5_0_5_174_5_221_5_268_5_315_",
         "5_174_5_221_5_268_5_315_362_",
         "5_179_453_226_5_180_453_227_5_181_453_228_5_180_453_227_5_179_453_226_",
         "302_0_5_179_453_226_5_180_453_227_5_181_453_228_",
         "5_179_453_226_5_178_453_225_178_453_225_177_0_224_177_302_224_",
      },
      iceman={
         "300_315_0_335_",
         "442_457_0_213_427_427_",
         "213_427_427_427_213_427_339_0_427_320_",
         "5_240_480_320_5_239_480_320_5_238_480_320_239_480_320_5_239_480_320_",
         "240_480_480_238_480_480_240_480_480_242_480_480_240_480_",
         "239_0_320_240_320_241_320_242_320_241_320_",
      },
      fireman={
         "110_125_0_157_",
         "15_0_51_15_641_32_641_13_641_6_641_",
         "302_302_254_302_0_6_302_641_0_6_339_679_",
         "403_641_403_0_5_403_302_254_5_0_5_453_641_",
         "5_0_5_453_641_453_0_453_121_115_453_142_130_",
      },
      bombman={
         "403_0_3_403_3_0_3_403_",
         "0_9_160_0_201_9_160_403_201_160_403_201_0_",
         "379_252_0_403_0_3_403_",
         "269_403_320_269_0_320_3_269_403_320_269_0_320_3_269_403_320_",
         "3_0_3_302_403_359_302_403_359_0_3_269_403_320_",
         "269_0_320_3_269_403_320_0_3_320_0_403_3_0_",
      },
      hopsh={
         "58_0_41_57_0_40_56_0_39_55_0_38_54_0_37_",
         "66_0_49_65_0_48_64_0_47_63_0_46_62_0_45_",
         "53_0_36_52_0_35_0_66_0_49_65_0_48_",
      },
      wily_stage_1={
         --1, 2 stages
         "302_0_254_302_302_0_5_254_302_302_",
         "254_302_302_0_5_254_302_302_5_302_5_226_302_269_",
         "226_302_269_226_0_269_226_302_269_302_0_",
         "5_226_302_269_226_302_269_226_0_269_226_302_269_302_",
         "5_302_5_226_302_269_226_302_269_226_0_269_226_302_269_"
      },
      wily_stage_2={
         "571_571_381_572_571_382_573_571_383_572_571_382_572_0_382_",
         "573_571_383_572_571_382_572_0_382_571_285_381_570_285_380_",
         "5_570_381_380_5_571_381_381_5_572_381_382_573_381_383_573_0_383_",
         "0_127_0_571_571_381_572_571_382_573_571_383_",
         "0_142_0_0_127_0_571_571_381_",
         "570_571_380_571_571_381_572_571_382_572_0_382_573_285_383_",
      },

      robotmaster_fight={
         --cutman
         "720_721_719_721_720_720_679_721_",
         "679_721_680_721_680_681_679_681_680_",
         "681_679_681_680_680_719_681_720_681_",
         --elecman
         "721_0_719_721_0_720_0_720_679_0_721_680_0_721_",
         "679_0_721_680_0_721_680_0_681_0_679_681_0_680_",
         "681_0_679_681_0_680_0_680_719_0_681_720_0_681_",
         --iceman
         "607_605_607_606_606_719_607_720_607_",
         "720_571_721_572_721_572_573_571_",
         "571_721_572_721_572_573_571_573_572_",
         --fireman
         "540_538_540_539_539_719_540_720_540_",
         "509_510_508_510_509_509_719_510_",
         --bombman
         "721_0_719_721_0_720_0_720_605_0_721_606_0_721_",
         "607_0_605_607_0_606_0_606_719_0_607_720_0_607_",
      },
      wily_fight={
         --stage_1
         "168_381_253_381_191_381_255_192_381_256_191_381_255_",
         "381_191_381_255_192_381_256_191_381_255_190_381_254_",
         "191_381_255_192_381_256_191_381_255_190_381_254_189_381_253_",
         --stage_2
         "169_381_254_168_381_253_381_191_381_255_192_381_256_",
         "191_381_255_190_381_254_189_381_253_381_170_381_255_",
         "171_381_256_170_381_255_169_381_254_168_381_253_381_",
         --stage_3
         "169_381_254_168_381_253_381_161_381_191_162_381_192_",
         "161_381_191_162_381_192_161_381_191_160_381_190_159_381_189_",
         "170_381_255_169_381_254_168_381_253_381_161_381_191_",
         --stage_4
         "190_381_254_189_381_253_381_170_381_255_171_381_256_",
         "5_256_381_322_5_255_381_321_5_254_381_320_5_253_381_319_5_381_",
      },
      victory={
         --cutman
         "5_188_339_5_186_339_5_184_339_5_339_5_149_339_149_",
         "5_184_339_5_339_5_149_339_149_147_339_147_145_339_145_",
         --gutsman
         "5_69_339_184_5_339_149_339_149_5_147_339_147_5_145_339_145_",
         --elecman
         "5_184_339_5_339_149_339_149_147_339_147_145_339_145_",
         "91_339_73_89_339_71_339_5_73_339_188_5_71_339_186_",
         --iceman
         "145_339_145_339_125_339_61_123_339_59_121_339_57_",
         "5_339_5_93_339_75_5_91_339_73_5_89_339_71_339_269_",
         --fireman
         "89_339_71_339_5_73_339_188_5_71_339_186_5_69_339_184_",
         "339_269_5_679_339_269_5_679_339_5_339_339_5_538_339_339_",
         --bombman
         "0_89_0_5_188_339_5_186_339_5_184_339_",
         "0_5_188_339_5_186_339_5_184_339_5_339_",
         --wily_stage_1_2
         "369_0_335_416_0_382_0_5_169_339_339_84_",
         "5_169_339_339_84_226_339_84_226_339_226_339_113_",
         --wily_stage_3
         "5_169_427_5_169_427_106_427_106_5_169_427_5_169_427_106_",
         "5_169_427_106_169_427_106_5_169_427_106_0_106_5_151_381_",
      },
      wily_defeated={
         "403_201_403_269_403_320_403_453_403_",
         "201_403_269_403_320_403_453_403_269_403_403_",
         "339_403_201_403_226_403_320_403_201_403_269_",
      },
      ending={
         "120_302_201_120_302_200_120_302_201_120_302_202_120_302_201_",
         "120_302_202_120_302_201_120_302_200_120_302_201_120_302_202_",
         "120_302_201_120_302_200_120_302_120_302_152_121_302_151_",
         '121_302_150_120_302_151_120_302_152_119_302_151_119_302_150_',
      },
   },

   MegaMan2={
      opening={
         "240_302_241_302_242_302_241_302_240_302_",
         "241_302_242_302_241_302_240_302_239_302_",
         "239_302_240_302_240_302_201_241_302_201_242_302_201_",
      },
      opening_main_menu={
         "136_146_148_136_147_149_0_2_213_213_285_213_213_285_",
         "0_2_213_213_285_213_213_285_0_2_213_213_285_",
         "2_213_213_285_213_213_285_0_11_213_213_285_9_213_213_285_",
      },
      choose_screen={
         "0_2_134_254_201_134_254_201_2_134_254_201_134_254_201_",
         "2_134_254_201_134_254_201_2_134_254_201_134_254_201_134_0_201_",
         "0_7_134_254_201_134_0_201_2_134_127_201_134_127_201_",
         "10_100_9_116_0_261_135_282_150_",
         "261_135_282_150_303_165_324_180_345_195_",
         "480_480_320_0_2_403_0_480_403_0_480_403_480_",
         "2_320_158_403_320_174_403_320_190_403_320_206_403_320_222_403_",
         "2_339_158_285_339_174_285_339_190_285_339_206_285_339_222_285_",
         "320_174_240_320_190_240_320_206_240_320_222_240_320_238_240_",
      },
      choose_robotmaster={
         "364_0_177_301_213_114_238_213_51_175_213_112_213_",
         "301_213_114_238_213_51_175_213_112_213_49_213_",
         "238_213_51_175_213_112_213_49_213_213_",
      },
      metalman={
         "3_477_269_3_474_269_3_477_269_3_480_269_483_269_",
         "486_269_3_483_269_240_3_480_269_240_3_477_240_3_474_240_",
         "3_477_240_201_3_480_240_201_3_483_240_201_3_486_240_201_483_240_201_",
         "269_538_0_3_201_240_177_3_201_240_248_3_201_240_313_",
         "3_201_302_240_201_302_240_3_201_302_240_201_302_240_0_",
         "3_320_240_201_320_240_201_0_12_269_269_213_11_269_269_213_",
      },
      flashman={
         "11_679_339_0_679_339_5_679_339_10_679_339_15_679_339_",
         "0_571_285_679_5_571_285_679_10_571_285_679_15_571_285_679_0_679_",
         "4_679_679_679_679_0_679_11_571_285_679_0_571_285_679_",
         "4_254_339_285_254_339_285_0_4_226_339_302_226_339_302_",
         "226_285_285_226_0_4_226_0_226_226_0_",
         "381_286_285_381_302_285_381_318_285_381_334_285_381_350_285_",
      },
      woodman={
         "715_0_763_0_0_12_475_150_143_12_523_166_159_",
         "12_523_166_159_12_571_182_175_12_619_198_191_12_667_214_207_12_715_",
         "12_619_198_191_12_667_214_207_12_715_12_763_12_262_",
         "10_254_302_302_10_256_302_302_10_254_302_302_10_252_302_10_254_302_",
         "4_254_302_302_254_302_302_254_0_302_10_254_302_302_10_256_302_302_",
         "10_302_339_337_10_302_339_10_302_341_302_0_4_302_339_302_",
      },
      crashman={
         "282_187_0_3_571_285_571_285_571_285_571_",
         "3_571_285_571_285_571_285_571_571_571_0_571_",
         "5_158_5_174_5_190_5_206_5_222_",
         "160_320_190_160_320_11_160_320_208_12_160_320_308_13_160_320_403_",
         "10_160_503_160_8_160_195_11_160_295_14_160_390_",
         "10_160_780_9_160_870_8_160_965_11_160_14_160_",
      },
      heatman={
         "0_2_762_381_608_2_762_381_645_2_762_381_682_2_762_381_719_",
         "2_762_381_645_2_762_381_682_2_762_381_719_2_762_381_756_0_",
         "0_2_381_190_250_381_190_287_381_190_324_381_190_361_",
         "2_254_320_254_0_320_2_254_381_320_254_381_320_254_0_320_",
         "254_0_320_2_254_190_320_254_190_320_254_190_325_254_0_325_",
         "2_254_381_325_254_381_325_254_0_325_2_254_213_254_0_",
      },
      bubbleman={
         "0_3_571_359_571_359_571_359_719_571_0_719_",
         "571_0_719_3_571_142_719_571_142_719_571_142_571_142_285_",
         "3_571_179_285_571_179_285_571_179_571_179_359_571_0_359_",
         "427_359_427_359_719_427_0_719_3_427_142_719_427_142_719_",
         "10_229_179_285_9_245_179_285_8_261_179_285_7_277_179_285_6_293_179_",
         "3_341_179_359_2_357_179_359_0_359_3_427_359_359_427_359_359_",
      },
      airman={
         "279_184_282_187_0_5_320_240_403_320_240_403_",
         "0_5_320_240_403_320_240_403_320_0_403_5_320_0_403_",
         "10_269_168_320_10_269_184_320_10_269_200_320_10_269_216_320_10_269_232_320_",
         "0_10_269_136_320_10_269_152_320_10_269_168_320_10_269_184_320_",
         "10_269_200_320_10_269_216_320_10_269_232_320_269_248_320_269_264_320_",
         "5_285_320_339_285_320_339_285_0_339_5_285_269_339_285_269_339_",
      },
      quickman={
         "282_187_0_4_285_213_285_213_4_285_213_",
         "285_213_4_285_213_285_213_285_285_285_0_285_",
         "1_213_4_213_359_7_213_359_10_0_359_13_213_0_359_",
         "4_213_213_213_213_213_4_213_213_213_",
         "10_359_285_285_13_359_285_285_359_285_285_359_285_359_285_359_",
         "0_213_4_285_213_213_285_213_213_4_285_213_213_4_285_213_",
      },
      hopsh={
         "66_0_62_65_0_61_64_0_60_63_0_59_62_0_58_",
         "62_0_58_61_0_57_60_0_56_59_0_55_58_0_54_",
         "58_0_54_57_0_53_56_0_52_55_0_51_54_0_50_",
      },
      castle={
         "285_301_317_333_349_",
         "7_83_7_99_7_115_7_131_7_147_",
         "7_419_7_435_0_3_269_269_268_3_269_269_267_",
         "3_269_269_268_3_269_269_267_3_269_269_266_269_269_265_269_269_264_",
         "269_269_265_269_269_264_269_269_263_269_269_262_269_269_261_",
      },
      wily_stage_1={
         "0_2_403_201_403_201_0_2_339_201_403_",
         "0_2_339_201_403_339_201_403_0_2_339_201_403_",
         "2_403_201_538_403_201_538_403_0_538_2_403_201_538_403_201_538_",
      },
      wily_stage_2={
         "0_2_359_359_359_2_362_359_359_2_365_359_359_",
         "362_0_359_2_362_359_359_2_359_359_359_2_356_359_359_353_0_359_",
         "2_353_359_359_356_0_359_2_356_403_359_2_359_403_359_2_362_403_359_",
      },
      fight={
         "0_9_0_100_0_722_213_427_725_213_427_",
         "0_722_213_427_725_213_427_722_213_427_719_213_427_",
         "722_213_427_725_213_427_722_213_427_719_0_427_716_213_427_",
         --wily bosses
         "2_302_226_359_0_2_722_213_427_725_213_427_213_",
         "108_0_86_2_106_213_84_104_213_82_213_108_213_86_",
         "7_104_213_82_7_213_7_108_0_86_7_106_213_84_7_104_213_82_",
         "106_213_84_104_0_82_213_108_213_86_106_213_84_",
         "608_240_302_611_240_302_608_240_302_605_240_302_602_240_302_",
         "11_611_213_295_14_608_213_390_13_605_0_490_12_602_213_585_11_599_213_685_",
         "10_602_213_780_9_605_213_870_8_608_213_965_11_611_0_14_608_213_",
         "12_602_213_469_12_599_213_413_12_602_213_357_12_605_213_301_12_608_0_245_",
         "608_213_685_12_611_213_629_12_608_0_577_12_605_213_525_12_602_213_469_",
      },
      win={
         "163_179_195_211_227_",
         "115_131_147_163_179_",
         "179_195_211_227_243_",
         --airman with wood weapon
         "4_0_68_4_83_67_4_99_66_115_3_131_141_",
         "4_163_70_4_179_69_4_195_68_4_211_67_4_227_66_",
      },
      weapons_ready={
         "10_100_9_116_8_132_7_148_6_164_",
         "6_164_5_180_4_196_3_212_2_228_",
         "245_261_277_0_10_100_",
      },
      wily_defeated={
         "12_0_11_0_0_3_213_213_285_213_213_285_",
         "213_213_285_3_213_213_285_213_213_285_213_0_285_3_213_213_285_",
         "3_213_213_285_213_213_285_3_213_213_285_213_213_285_213_0_285_",
      },
      titles={
         "0_270_254_0_271_254_0_270_254_0_269_254_0_268_254_",
         "0_269_254_0_268_254_0_267_254_267_254_268_254_",
         "270_254_269_271_254_269_270_254_269_269_254_269_268_254_269_",
      }
   }
}



local function get_sound_data(data)
   result = ""
   if data["noise"]["volume"] > 0 then
      result = result..data["noise"]["regs"]["frequency"].."_"
   end
   if data["square1"]["volume"] > 0 then
      result = result..data["square1"]["regs"]["frequency"].."_"
   end
   if data["dpcm"]["volume"] > 0 then
      result = result..data["dpcm"]["regs"]["frequency"].."_"
   end
   if data["triangle"]["volume"] > 0 then
      result = result..data["triangle"]["regs"]["frequency"].."_"
   end
   if data["square2"]["volume"] > 0 then
      result = result..data["square2"]["regs"]["frequency"].."_"
   end
   return result
end


debug_sound_data = string.match(tostring(arg), "debug") ~= nil
current_level = ""
current_sound_data_line = ""
prev_value = ""
current_data = {"", "", "", "", ""}
check_list = check_list_data[rom.getfilename()]
print("MegaMan Epic Guitar Collection")
print(rom.getfilename())
print("")
print("for disabling music enter \"stop\" in arguments and restart")
print("for enable music data enter \"debug\" in arguments and restart")
print("")
print("gl hf!")
print("")

while true do
   emu.frameadvance()
   a = sound.get()["rp2a03"]
   sound_data = get_sound_data(a)
   
   if sound_data ~= prev_value then
      table.insert(current_data, sound_data)
      table.remove(current_data, 1)
      current_sound_data_line = table.concat(current_data)

      if debug_sound_data then
         print(current_sound_data_line)
      end

      for key, value in pairs(check_list) do
         for k, val in pairs(value) do
            if val == current_sound_data_line and key ~= current_level then
               for key2 in pairs(check_list) do
                  os.remove("data/current_data/"..key2..".txt")
               end
               if string.match(tostring(arg), "stop") ~= nil then
                  file = io.open("data/current_data/initial.txt", "w")
               else
                  file = io.open("data/current_data/"..key..".txt", "w")
               end
               file:write()
               file:close()
               current_level = key
               print("now playing: "..key)
            end
         end
      end
      prev_value = sound_data
   end
end